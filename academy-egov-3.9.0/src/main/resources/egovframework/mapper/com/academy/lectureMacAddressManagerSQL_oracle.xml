<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="macaddressmanager">

	<select id="macaddressmanagerList" parameterType="hashMap" resultType="hashMap">
		SELECT * FROM (
			SELECT A.*, ROWNUM rnum
		  	FROM ( 
		  	          SELECT 
	                           A.USER_ID, A.DEVICE_ID, A.DEVICE_GUBUN, 
	                           A.PC_USEYN, A.PC_REG_DT, A.MOBILE_REG_DT, A.PC_CANCEL_DT, A.MOBILE_CANCEL_DT,
	                           A.DEVICE_DESC, A.ADMIN_ID, A.SEQ, B.USER_NM, A.MOBILE_USEYN, A.MAC_ADDR
	                  FROM TM_DEVICE_HISTORY A, TB_MA_MEMBER B 
	                  WHERE A.USER_ID = B.USER_ID
					<if test="SEARCHTEXT != null and SEARCHTEXT != ''">
						<if test="SEARCHTYPE != null and SEARCHTYPE != ''">
							<if test="SEARCHTYPE == 1">
	  				  AND INSTR(A.USER_ID, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
							</if>
							<if test="SEARCHTYPE == 2">
		              AND INSTR(B.USER_NM, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
							</if>
						</if>
						<if test="SEARCHTYPE == null or SEARCHTYPE == ''">
	                  AND (INSTR(A.USER_ID, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
		                      OR INSTR(B.USER_NM, #{SEARCHTEXT}) <![CDATA[ > ]]> 0)
						</if>
					</if>
					  AND (PC_USEYN = 'Y' or MOBILE_USEYN = 'Y')
	                  ORDER BY USER_ID, PC_REG_DT DESC, MOBILE_REG_DT DESC
					) A
               	WHERE rownum <![CDATA[ <= ]]> #{endNo}
			)
		WHERE rnum <![CDATA[ > ]]> #{startNo}
	</select>

	<select id="macaddressmanagerListCount" parameterType="hashMap" resultType="int">
				  SELECT COUNT(*) 
                  FROM TM_DEVICE_HISTORY A, TB_MA_MEMBER B 
                  WHERE A.USER_ID = B.USER_ID
				<if test="SEARCHTEXT != null and SEARCHTEXT != ''">
					<if test="SEARCHTYPE != null and SEARCHTYPE != ''">
						<if test="SEARCHTYPE == 1">
  				  AND INSTR(A.USER_ID, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
						</if>
						<if test="SEARCHTYPE == 2">
	              AND INSTR(B.USER_NM, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
						</if>
					</if>
					<if test="SEARCHTYPE == null or SEARCHTYPE == ''">
                  AND (INSTR(A.USER_ID, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
	                      OR INSTR(B.USER_NM, #{SEARCHTEXT}) <![CDATA[ > ]]> 0)
					</if>
				</if>
				AND (PC_USEYN = 'Y' or MOBILE_USEYN = 'Y')
	</select>
	
	<select id="macaddressView" parameterType="hashMap" resultType="hashMap">
		SELECT 
					A.USER_ID, A.DEVICE_ID, A.DEVICE_GUBUN, 
					   A.PC_USEYN, A.MOBILE_USEYN, A.PC_REG_DT,A.MOBILE_REG_DT, A.PC_CANCEL_DT, A.MOBILE_CANCEL_DT,
					   A.DEVICE_DESC, A.ADMIN_ID, A.SEQ, B.USER_NM, A.MAC_ADDR
					FROM TM_DEVICE_HISTORY A
					LEFT OUTER JOIN TB_MA_MEMBER B ON A.USER_ID = B.USER_ID
		WHERE SEQ = #{SEQ}
	</select>
	
	<select id="devicelist" parameterType="hashMap" resultType="hashMap">

	     SELECT A.*, NVL(PC_CANCEL_DT, MOBILE_CANCEL_DT) CANCEL_DT FROM TM_DEVICE_HISTORY A
         WHERE USER_ID = #{V_USER_ID}
         AND (PC_USEYN = 'N' OR MOBILE_USEYN = 'N')
         ORDER BY CANCEL_DT DESC
	</select>

	<update id="macaddressmanagerUpdate" parameterType="hashMap">
		UPDATE TM_DEVICE_HISTORY
		SET
			PC_USEYN = 'N',PC_CANCEL_DT = SYSDATE, ADMIN_ID = #{UPD_ID}
		WHERE SEQ = #{SEQ}
	</update>
	
	<update id="macaddressmanagerUpdate1" parameterType="hashMap">
		UPDATE TM_DEVICE_HISTORY
		SET
			MOBILE_USEYN = 'N', MOBILE_CANCEL_DT = SYSDATE, ADMIN_ID = #{UPD_ID}
		WHERE SEQ = #{SEQ}
	</update>

	<select id="MacAdrUserList" parameterType="hashMap" resultType="hashMap">
		SELECT * FROM (
			SELECT A.*, ROWNUM rnum
	  		FROM ( 
					SELECT 
					       A.USER_ID, B.USER_NM
                  FROM TM_DEVICE_HISTORY A, TB_MA_MEMBER B 
                  WHERE A.USER_ID = B.USER_ID
				<if test="SEARCHTEXT != null and SEARCHTEXT != ''">
					<if test="SEARCHTYPE != null and SEARCHTYPE != ''">
						<if test="SEARCHTYPE == 1">
  				  AND INSTR(A.USER_ID, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
						</if>
						<if test="SEARCHTYPE == 2">
	              AND INSTR(B.USER_NM, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
						</if>
					</if>
					<if test="SEARCHTYPE == null or SEARCHTYPE == ''">
                  AND (INSTR(A.USER_ID, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
	                      OR INSTR(B.USER_NM, #{SEARCHTEXT}) <![CDATA[ > ]]> 0)
					</if>
				</if>
				GROUP BY A.USER_ID, B.USER_NM
				ORDER BY A.USER_ID
				) A
               	WHERE rownum <![CDATA[ <= ]]> #{endNo}
			)
		WHERE rnum <![CDATA[ > ]]> #{startNo}
	</select>

	<select id="MacAdrUserCount" parameterType="hashMap" resultType="int">
				  SELECT COUNT(*) 
	  		FROM ( 
                SELECT A.USER_ID, B.USER_NM
                  FROM TM_DEVICE_HISTORY A, TB_MA_MEMBER B 
                  WHERE A.USER_ID = B.USER_ID
				<if test="SEARCHTEXT != null and SEARCHTEXT != ''">
					<if test="SEARCHTYPE != null and SEARCHTYPE != ''">
						<if test="SEARCHTYPE == 1">
  				  AND INSTR(A.USER_ID, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
						</if>
						<if test="SEARCHTYPE == 2">
	              AND INSTR(B.USER_NM, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
						</if>
					</if>
					<if test="SEARCHTYPE == null or SEARCHTYPE == ''">
                  AND (INSTR(A.USER_ID, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
	                      OR INSTR(B.USER_NM, #{SEARCHTEXT}) <![CDATA[ > ]]> 0)
					</if>
				</if>
				GROUP BY A.USER_ID, B.USER_NM
		)
	</select>

	<select id="MacAdrUserAllList" parameterType="hashMap" resultType="hashMap">
		SELECT 
	            A.USER_ID, A.DEVICE_ID, A.DEVICE_GUBUN, 
	            A.PC_USEYN, A.PC_REG_DT, A.MOBILE_REG_DT, A.PC_CANCEL_DT, A.MOBILE_CANCEL_DT,
	            A.DEVICE_DESC, A.ADMIN_ID, A.SEQ, B.USER_NM, A.MOBILE_USEYN, A.MAC_ADDR
		FROM TM_DEVICE_HISTORY A, TB_MA_MEMBER B 
	    WHERE A.USER_ID = B.USER_ID
		<if test="SEARCHTEXT != null and SEARCHTEXT != ''">
			<if test="SEARCHTYPE != null and SEARCHTYPE != ''">
				<if test="SEARCHTYPE == 1">
	  	AND INSTR(A.USER_ID, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
				</if>
				<if test="SEARCHTYPE == 2">
		AND INSTR(B.USER_NM, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
				</if>
			</if>
			<if test="SEARCHTYPE == null or SEARCHTYPE == ''">
	    AND (INSTR(A.USER_ID, #{SEARCHTEXT}) <![CDATA[ > ]]> 0
		        OR INSTR(B.USER_NM, #{SEARCHTEXT}) <![CDATA[ > ]]> 0)
			</if>
		</if>
        ORDER BY USER_ID, PC_REG_DT DESC, MOBILE_REG_DT DESC
	</select>

	<update id="MacAdrUserUpdate" parameterType="hashMap">
		UPDATE TM_DEVICE_HISTORY
		SET
			PC_USEYN = 'N',
			PC_CANCEL_DT = SYSDATE, 
			MOBILE_USEYN = 'N',
			MOBILE_CANCEL_DT = SYSDATE, 
			ADMIN_ID = #{UPD_ID}
		WHERE USER_ID = #{V_USER_ID}
		AND (PC_USEYN = 'Y' OR MOBILE_USEYN = 'Y') 
	</update>

</mapper>