<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pub">

    <resultMap type="java.util.HashMap" id="boardMap">
       <result column="PUB_CONTENTS" property="PUB_CONTENTS" javaType="java.lang.String" jdbcType="CLOB"/>
    </resultMap>
	
	<select id="getPubCategory" parameterType="hashMap" resultType="hashMap">
		SELECT IDX, NM, P_IDX, LVL, SEQ
		FROM TB_GOSI_PUB_CAT
		CONNECT BY PRIOR IDX = P_IDX                
		START WITH P_IDX = -1
	    ORDER BY SEQ ASC
	</select>
	
	<select id="getPubCategoryOne" parameterType="hashMap" resultType="hashMap">
		SELECT IDX, NM, P_IDX, LVL, SEQ
		FROM TB_GOSI_PUB_CAT
		WHERE IDX = #{IDX}
	    ORDER BY SEQ ASC
	</select>
	
	<insert id="insertPubCategory" parameterType="hashMap">
		INSERT INTO TB_GOSI_PUB_CAT (
			IDX, NM, P_IDX, LVL, SEQ
		) VALUES (
			(SELECT MAX(IDX)+1 FROM TB_GOSI_PUB_CAT), #{NM}, #{P_IDX}, #{LVL}, #{SEQ}
		)
	</insert>
	
	<update id="updatePubCategory" parameterType="hashMap" flushCache="true">
		UPDATE TB_GOSI_PUB_CAT
		SET NM = #{NM},
		SEQ = #{SEQ}
		WHERE IDX = #{IDX}
	</update>
	
	<delete id="deletePubCategory" parameterType="hashMap">
		DELETE 
		FROM TB_GOSI_PUB_CAT 
		WHERE IDX = #{IDX}
	</delete>
	
	<select id="getPubCategorySel" parameterType="hashMap" resultType="hashMap">
		SELECT *
		FROM TB_GOSI_PUB_CAT
		WHERE 1=1
	    <if test="MAIN_PID != null and MAIN_PID != ''">
    	AND P_IDX = #{MAIN_PID}
	    </if>
	    <if test="LVL != null and LVL != ''">
    	AND LVL = #{LVL}
	    </if>
	    ORDER BY SEQ ASC
	</select>
	
	<select id="getPubGubun" parameterType="hashMap" resultType="hashMap">
		SELECT *
		FROM TB_BA_CONFIG_CD
		WHERE SYS_CD = 'EXAM_INFO_TYPE'
		ORDER BY CODE_NO
	</select>
	
	<select id="getPubList" parameterType="hashMap" resultType="hashMap">
		SELECT * 
		        FROM(
		            SELECT A.*, ROWNUM RNUM
		            FROM(
		                SELECT X.PUB_NO, X.PUB_YEAR, X.PUB_CAT, 
		                X.MAIN_PID, (SELECT NM FROM TB_GOSI_PUB_CAT WHERE IDX = X.MAIN_PID) MAIN_NM,
		                X.SUB_PID, (SELECT NM FROM TB_GOSI_PUB_CAT WHERE IDX = X.SUB_PID) SUB_NM,
		                X.PUB_TITLE, X.PUB_CONTENTS, Z.CODE_NM
		                FROM TB_GOSI_PUB_NOTICE X, TB_BA_CONFIG_CD Z
		                WHERE X.PUB_CAT = Z.CODE_VAL
		                AND Z.SYS_CD = 'EXAM_INFO_TYPE'
				    	<if test="SEARCH_YEAR != null and SEARCH_YEAR != ''">
				    	AND X.PUB_YEAR = #{SEARCH_YEAR}
				    	</if>
				    	<if test="SEARCH_GUBUN != null and SEARCH_GUBUN != ''">
				    	AND X.PUB_CAT = #{SEARCH_GUBUN}
				    	</if>
				    	<if test="S_MAIN_PID != null and S_MAIN_PID != '' and S_MAIN_PID != '0'">
				    	AND X.MAIN_PID = #{S_MAIN_PID}
				    	</if>
				    	<if test="S_SUB_PID != null and S_SUB_PID != ''">
				    	AND X.SUB_PID = #{S_SUB_PID}
				    	</if>
				    	<if test="SEARCHTEXT != null and SEARCHTEXT != ''">
				    	AND INSTR(X.PUB_TITLE, #{SEARCHTEXT}) <![CDATA[ > ]]> 0 
				    	</if>
				    	ORDER BY X.PUB_NO DESC
		            ) A
		            WHERE rownum <![CDATA[ <= ]]> #{endNo}
		        )WHERE rnum <![CDATA[ > ]]> #{startNo}
	</select>
	
	<select id="getPubListCount" parameterType="hashMap" resultType="int">
		SELECT COUNT(*)   
		                FROM TB_GOSI_PUB_NOTICE X, TB_BA_CONFIG_CD Z
		                WHERE X.PUB_CAT = Z.CODE_VAL
		                AND Z.SYS_CD = 'EXAM_INFO_TYPE'
				    	<if test="SEARCH_YEAR != null and SEARCH_YEAR != ''">
				    	AND X.PUB_YEAR = #{SEARCH_YEAR}
				    	</if>
				    	<if test="SEARCH_GUBUN != null and SEARCH_GUBUN != ''">
				    	AND X.PUB_CAT = #{SEARCH_GUBUN}
				    	</if>
				    	<if test="S_MAIN_PID != null and S_MAIN_PID != '' and S_MAIN_PID != '0'">
				    	AND X.MAIN_PID = #{S_MAIN_PID}
				    	</if>
				    	<if test="S_SUB_PID != null and S_SUB_PID != ''">
				    	AND X.SUB_PID = #{S_SUB_PID}
				    	</if>
				    	<if test="SEARCHTEXT != null and SEARCHTEXT != ''">
				    	AND INSTR(X.PUB_TITLE, #{SEARCHTEXT}) <![CDATA[ > ]]> 0 
				    	</if>
	</select>
	
	<select id="getPubOne" parameterType="hashMap" resultMap="boardMap">
		SELECT * 
		FROM TB_GOSI_PUB_NOTICE
		WHERE PUB_NO = #{PUB_NO}
	</select>
	
	<insert id="Pub_Insert" parameterType="hashMap" flushCache="true">
		INSERT INTO TB_GOSI_PUB_NOTICE (
			PUB_NO,
			PUB_YEAR,  PUB_CAT, MAIN_PID, SUB_PID, 
			PUB_TITLE, PUB_CONTENTS, 
			REG_DT, REG_ID, HITS
		) VALUES(
			(SELECT NVL(MAX(PUB_NO), 0)+1 FROM TB_GOSI_PUB_NOTICE),
			#{PUB_YEAR}, #{PUB_CAT}, #{MAIN_PID}, #{SUB_PID},
			#{PUB_TITLE}, #{PUB_CONTENTS},
			SYSDATE, #{REG_ID}, 0
		)
	</insert>
	
	<update id="Pub_Update" parameterType="hashMap" flushCache="true">
		UPDATE TB_GOSI_PUB_NOTICE
		SET PUB_YEAR = #{PUB_YEAR},
		PUB_CAT = #{PUB_CAT},
		MAIN_PID = #{MAIN_PID},
		SUB_PID = #{SUB_PID},
		PUB_TITLE = #{PUB_TITLE},
		PUB_CONTENTS = #{PUB_CONTENTS}
		WHERE PUB_NO = #{PUB_NO}
	</update>
	
	<delete id="Pub_delete" parameterType="hashMap">
		DELETE 
		FROM TB_GOSI_PUB_NOTICE
		WHERE PUB_NO = #{PUB_NO}
	</delete>

	<select id="getMaxPubNo" parameterType="hashMap" resultType="int">
	    SELECT MAX(PUB_NO) 
	    FROM TB_GOSI_PUB_NOTICE
	</select>
	
	<select id="getPubFiles" parameterType="hashMap" resultType="hashMap">
		SELECT *
		FROM TB_GOSI_PUB_FILE
		WHERE PUB_NO = #{PUB_NO}
    	<if test="FILE_NO != null and FILE_NO != ''">
    	AND FILE_NO = #{FILE_NO}
    	</if>
	</select>
	
	<update id="AttachFile_insert" parameterType="hashMap" flushCache="true">
		INSERT INTO TB_GOSI_PUB_FILE (
			PUB_NO, 
			FILE_NO, 
			FILE_NAME, FILE_PATH, REG_ID, REG_DT
		) VALUES(
			#{PUB_NO}, 
			(SELECT NVL(MAX(FILE_NO), 0)+1 FROM TB_GOSI_PUB_FILE),
			#{FILE_NAME}, #{FILE_PATH}, #{REG_ID}, SYSDATE
		)
	</update>
	
	<update id="AttachFile_delete" parameterType="hashMap" flushCache="true">
		DELETE 
		FROM TB_GOSI_PUB_FILE
		WHERE PUB_NO = #{PUB_NO}
		AND FILE_NO = #{FILE_NO}
	</update>
	
</mapper>